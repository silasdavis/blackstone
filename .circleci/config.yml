defaults: &defaults
  docker:
    - image: quay.io/monax/build:latest
  working_directory: ~/blackstone
  environment:
    IMAGE_API: quay.io/monax/blackstone

version: 2.1
jobs:
  test_contracts:
    machine: &machine_defaults
      enabled: true
      image: circleci/classic:201808-01
    steps:
    - checkout
    - run: make test_contracts

  test_api:
    machine: *machine_defaults
    steps:
      - checkout
      - run: make install_api
      - run: make test_api
      - persist_to_workspace:
          root: ./contracts/src/
          paths:
            - bin
      - store_artifacts:
          path: ./test/chain/burrow.log
      - store_artifacts:
          path: ./test-contracts-jobs.log
      - store_artifacts:
          path: ./test-contracts.log

  deploy_docs:
    <<: *defaults
    steps:
      - checkout
      - &add_ssh_key
        add_ssh_keys:
          fingerprints:
            - "5e:f3:47:75:34:c7:83:93:51:48:31:6a:3a:1a:de:85"
      - run: ./docs/generate.sh

  deploy_platform:
    docker:
      - image: appropriate/curl
    steps:
      - run:
          name: Trigger upgrade
          command: |
            set -x
            curl \
              --request POST \
              --form token=$PLATFORM_DEPLOY_KEY \
              --form ref=master \
              $PLATFORM_DEPLOY_URL

  update_info:
    docker:
      - image: alpine/git
    environment:
      CHAIN_INFO: "t5"
      CHAIN_INFO_HOST: "info.agreements.network"
    steps:
      - checkout
      - <<: *add_ssh_key
      - attach_workspace:
          at: /tmp
      - run: ./scripts/update_info.sh


workflows:
  version: 2
  test_and_deploy:
    jobs:
      - test_contracts
      - test_api
      - deploy_docs:
          filters:
            branches:
              only:
                - master
      - update_info:
          requires:
            - test_contracts
            - test_api
          filters:
            branches:
              only:
                - master
                - develop
      - deploy_platform:
          requires:
            - test_contracts
            - test_api
            - update_info
          filters:
            branches:
              only:
                - master
                - develop
